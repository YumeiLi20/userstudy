<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    #submitComments {
        position: relative;
        left: 50%;
        transform: translate(-50%, 0%);
    }
    body{
        color:#000;
    }
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 60px;
        height: 28px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }
    #container{
        /*Styling for any element with the id="container" */
        width:1800px; /* The width is fixed by pixels */
        height:800px; /* The height is fixed by pixels*/
        color:black;
    }
</style>
<body>
<div id="container">
    <div id="instruction" style="text-align:center;">
        <!--<h1 id="heading">Main Study</h1>-->
        <div id="notation" style="text-align:left;">
            <!--<label id="page"></label>-->
        </div>
        <br> <br>
        <div id="table"></div>
    </div>
    <br>
    <button id="submitComments" class="next-button" type="button">Ready to Answer Questions?</button><label id="answer_all" style="position: absolute; left: 150px; color: red;"></label><br>
</div>
<br>
</body>
</html>
<script>//display 6 record in page
(function(){
    $.getScript("javascript/misc/util.js");
    console.log(experimentr.data()["mat"]);
    experimentr.startTimer('main_section');
    experimentr.data()['section'] = 'mat';
    experimentr.hideNext();
    // pages

    var step = 0,
        sec_switch = 0;

    function delay_next(time){
        d3.select("#submitComments").attr("disabled","true");
        d3.select("#submitComments").style("color","#b3b3b3");
        setTimeout(function(){
            d3.select("#submitComments").attr("disabled",null);
            d3.select("#submitComments").style("color","black");
        },time);
    }

    delay_next(250);

    function add_mod_intros(img_address){
        var height = "550px",
            width = "1000px",
            x = "400px",
            y = "20px";

        d3.select("#notation").select(".image").remove();
        var svg = d3.select("#notation")
            .append("svg")
            .attr("class", "image")
            .attr("width", 1800)
            .attr("height", 600);
        svg.append("svg:image")
            .attr("xlink:href","/resources/module_intros/"+img_address)
            .attr("x",x)
            .attr("y",y)
            .attr("width",width)
            .attr("height",height);
        svg.append("rect")
            .attr("x", x)
            .attr("y", y)
            .attr("height", height)
            .attr("width", width)
            .style("stroke", "black")
            .style("fill", "none");
    }

    console.log(experimentr.data());
    add_mod_intros("recap_1.PNG");


    var mod_pages = [1,2,3,4];//key for which pages display recap slides


    function goToNext() {
        //delete experimentr.data()["mat"];
        experimentr.next();
    }
    var start = Date.now();
    var restore = {};
    function all_answered(){
        var prev = start;
        var answer = Object.keys(restore).length>0? restore:{};
        var text = [];
        d3.selectAll(".result").remove();
        start = Date.now();
        for(i in experimentr.data()["clicks"]){
            if(+experimentr.data()["clicks"][i][0]>+prev){
                answer[+experimentr.data()["clicks"][i][1]-1] = Math.floor(+experimentr.data()["clicks"][i][2]/3);
            }
        }
        if(Object.keys(answer).length < d3.selectAll(".blocks")[0].length){
            restore = answer;
            return(false);
//                disable_submit();
        } else {
            restore = {};
            return(true);
//                enable_submit();
        }
    };

    var start = Date.now();
    var restore = {};

    function formatted_join(string_array){
        if(string_array.length === 1){
            return(string_array);
        }else if(string_array.length === 2){
            return(string_array.join(" and "));
        } else{
            let res = string_array.slice(0,string_array.length-1).join(", ");
            return(res+" and "+string_array[string_array.length-1]);
        }
    };

    function feedback(){
            var questions = [];
            var data_pairs = experimentr.data()["mat"][step-1];
            for(var i =0; i<data_pairs.length; i++){
                questions.push(data_pairs[i][0][0])
            }
            var prev = start;
            var answer = Object.keys(restore).length>0 ? restore:{};
            var text = [];
            d3.selectAll(".result").remove();
            start = Date.now();
            for(i in experimentr.data()["clicks"]){
                console.log(experimentr.data()['clicks'][i][0], prev);
                if(experimentr.data()['clicks'][i][0] < prev){
                    answer[experimentr.data()["clicks"][i][1]-1] = Math.floor(experimentr.data()["clicks"][i][2]/3);
                }
                console.log(+experimentr.data()['clicks'][i][0]>+prev);
            }

            console.log(+experimentr.data()['clicks'][i][0]);
            console.log(experimentr.data()['clicks'][i][0]);
            console.log(experimentr.data()['mat_answer']);
            console.log(answer);
            console.log(experimentr.data()["clicks"]);
            //console.log(Object.keys(answer).length, d3.selectAll(".blocks")[0].length);
            //console.log(experimentr.data()['practice_answer']);

            var score = 0;
            var wrong_ans = [];
            for(i in answer){
                if(experimentr.data()['mat_answer'][+i]==answer[i]){
                    score+=1;
                }else{
                    wrong_ans.push((+i+1).toString());
                }
            }

            console.log(wrong_ans);

            var ans_ques = Object.keys(answer);
            var unaswered_ques = [];
            //console.log("wrong_ans",wrong_ans);
            //console.log("ans_ques",ans_ques);
            for(var i=0; i < questions.length;i++){
                if(ans_ques.indexOf((parseInt(questions[i])-1).toString())<0){
                    //console.log("q not answered");
                    unaswered_ques.push((questions[i]).toString());
                    wrong_ans.push((questions[i]).toString());
                }
            }

//
//                if(Object.keys(answer).length < d3.selectAll(".blocks")[0].length){
//                    text = ['You have to answer all the questions to proceed.'];
//                }

            if(wrong_ans.length > 0){
                text.push("Please review question(s) "+formatted_join(wrong_ans));
            }

            restore = answer;
            if(text.length==0){
                text = ['Good job! Please click "Next" button to proceed.'];
                d3.select("#submitComments").style("display","inline");
                d3.select("#submitAnswers").style("display","none");
//                    d3.select("#submitComments").attr("disabled",null);
//                    d3.select("#submitComments").style("color","black");
                restore = {};
            }
            d3.selectAll(".result").remove();
            d3.select("#notation")
                .append("h4")
                .attr("class","result")
                .text(text.join());


            if(text[0] === 'Good job! Please click "Next" button to proceed.'){
                return true;
            } else {
                return false;
            }
        };


    var mode_order = ["Vanilla","Full"];
    function render_content(){
        if(step==experimentr.data()["mat"].length-4){
           // experimentr.endTimer('main_section');
            console.log("In main_section",step);
            grading();
            goToNext();
        }else {

            if (sec_switch == 1 && (mod_pages.indexOf(step) > -1)) {
                console.log("Step is",step);
                d3.select('#submitComments').style("left", "50%").property("innerHTML","Ready to Answer Questions?");
                d3.selectAll(".blocks").remove();
                d3.select("#notation").html("");
                add_mod_intros("recap_" + (step + 1) + ".PNG");

                delay_next(250);
                sec_switch = 0
            } else {
//                    d3.select("#notation").text("Page " + (step + 1).toString() + "/" + (experimentr.data()['mat'].length - 1).toString());
                d3.select("#notation").text("");
                //console.log("Hi there is a notation");
                d3.select('#submitComments').style("left", "35px").property("innerHTML","Submit");
                ;
                setTimeout(function () {
                    d3.selectAll(".blocks").remove();
                    experimentr.data()["mode"] = mode_order[step - 1];
                    console.log(mode_order[step-1])
                    pairs(experimentr.data()["mat"][step - 1], step - 1, experimentr.data()["mat"][step - 1].length, experimentr.data()["mode"]);
                    if (experimentr.data()["mode"] == "Vanilla") {
                        d3.selectAll(".icon").remove();
                        d3.selectAll(".freq").remove();
                        d3.selectAll(".tip").remove();
                    }


                }, 100);

                delay_next(350);

                step += 1;
                sec_switch = 1;

            }
        }
    }

    d3.select('#submitComments')
        .on('click', function () {
            //console.log(experimentr.data());
            d3.select("#answer_all").text("");
            d3.select("#heading").remove();
            d3.select('#submitComments').style("left","2.5%");
            //console.log((Date.now()-experimentr.data()["time_of_website_start"])/(1000*60));
            if(parse_url().testing === 'true'){
                render_content();
            } else {
                if(d3.selectAll(".blocks")[0].length > 0){//blocks in number of questions in a page
                    if(all_answered()){
                        if(feedback()){
                            render_content();
                        }
                    } else {
                        d3.select("#answer_all").text("Please answer all questions to proceed")
                    }
                } else {
                    render_content();
                }
            }

            // time elapse
            experimentr.data()['switch'].push(Date.now());
            experimentr.save();
        });


}());
</script>