<h1>Instructions</h1>
<p>Hello, for the next while you will be completing some trials.</p>

<h2>What are these trials?</h2>

<style>
    #red {
        color: red;
        background-color: transparent;
    }

    #blue {
        color: blue;
        background-color: transparent;
    }
    table {
        border: 0;
        font: 14px sans-serif;
        border-collapse:collapse; 
    }

    td {
        border: 0;
        padding: 5px;
    }
    
</style>
<body>
<button id="ready_button" class="next-button" type="button">Next</button>
</body>



<script>
(function() {
  experimentr.hideNext();

  experimentr.startTimer('instructions');
  var dat = {};
  dat.clicks = [];
  var label = 0;
  var table = d3.select('table')
              .append("table")
              .attr("class","table");
  var group = [];
  var svg = d3.select("body").append("svg")
            .attr("width", 960)
            .attr("height", 800);
  var cwidth = [60,90,140,50,60,90,90]; //580
  parsing();
  console.log(experimentr.data()["mode"]);
  
  function parsing(){
    d3.text("data_alt.csv",function(csvdata){
      var groups = {};
        var parsedCSV = d3.csv.parseRows(csvdata);
        for(i=1;i<parsedCSV.length;i++){
          if (!(parsedCSV[i][0] in groups)){
            groups[parsedCSV[i][0]] = [parsedCSV[i]];
          }else{
            groups[parsedCSV[i][0]] = groups[parsedCSV[i][0]].concat([parsedCSV[i]]);
          }
        }
        var values = Object.keys(groups).map(function(key){return groups[key];}); 
        var raw_binary = values.filter(function(d){return d.length==2;});
        var binary = [];
        var other = [];
        var tmp = [];
        for(i=0;i<raw_binary.length;i++){
          if(tmp.length===5 || i===raw_binary.length-1){
            binary.push(tmp);
            tmp = [];
          }else{
            tmp.push(raw_binary[i]);
          }
        }
        var tmp = values.filter(function(d){return d.length==4;});
        for(i=0;i<tmp.length;i++){
          var t = [];
          for(j=0;j<tmp[i].length/2;j++){
            t.push([tmp[i][j],tmp[i][j+1]]);
          }
          other.push(t);
        }
        tmp = values.filter(function(d){return d.length==6;});
        for(i=0;i<tmp.length;i++){
          var t = [];
          for(j=0;j<tmp[i].length/2;j++){
            t.push([tmp[i][j],tmp[i][j+1]]);
          }
          other.push(t);
        }
        group = binary.concat(other);
        //console.log(group);
      });
  }

  function block(k,data,data_){
    var g = svg.append("g")
      .attr("transform","translate(0,"+100*k+")");
    if(experimentr.data()["mode"]=="Partial"){
      for(j=0;j<21;j++){
        var cell = g.append("g")
          .attr("transform","translate("+cwidth.slice(0,j%7).reduce(function(a, b){return a+b;},0)+","+30*Math.floor(j/7)+")");
        var rectangle = cell.append("rect");
        var textbox = cell.append("text");
        textbox.attr("x",cwidth[j%7]/2)
        .attr("y",function(d){return (j<14 && data[j]==data[j+7])||(j>6 && j%7==0) ? 33 : 18;})
        .attr("text-anchor","middle")
        .style("font","14px sans-serif")
        .style("font-weight", function(d) { return j<7 ? "bold" : ""; })
        .text(function(d){return (j>14 && data[j]==data[j-7])||j==14 ? "" : data[j];})
        .on('mouseover', function(d){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          var rect = d3.select(this.parentNode).select("rect");
          if(indice>6 && indice%7!=0){     
            rect.transition().duration(500)
            .attr("x",1-0.1*(cwidth[indice%7]-2)).attr("y",-5).attr("width",(cwidth[indice%7]-2)*1.2).attr("height",function(d){
              return d3.select(this.parentNode).select("text").attr("y")==33 ? 65 : 35;
            }).style("opacity",1.0);
            d3.select(this).transition().duration(500).style('font-size', '18px');
          }})
        .on('mouseout', function(d){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          var rect = d3.select(this.parentNode).select("rect");
          if(indice>6 && indice%7!=0){      
            rect.transition().duration(500)
            .attr("x",1).attr("y",0).attr("width",cwidth[indice%7]-2).attr("height",function(d){
              return d3.select(this.parentNode).select("text").attr("y")==33 ? 55 : 25;
            }).style("opacity",0.75);
            d3.select(this).transition().duration(500).style('font-size', '14px');
          }})
        .on('click',function(d){if(data.indexOf(this.textContent)>6){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          console.log(d3.select(this)[0][0].innerHTML,Date.now());
          dat.clicks.push([k,indice,d3.select(this)[0][0].innerHTML, Date.now()]);
          if(d3.select(this)[0][0].innerHTML == data[indice]){
            d3.select(this).text(data_[indice]);
            //if(d3.select(this).attr("y")==33){
              //d3.select(this).attr("y",18);

            //}
          }
        }});
        
        rectangle.attr("x",1)
        .attr("y",0)
        .attr("width",cwidth[j%7]-2)
        .attr("height",function(d){if ((j>14 && data[j]==data[j-7])||j==14){return 0;}return (j<14 && data[j]==data[j+7])||j==7 ? 55 : 25;})
        .style("fill",function(d){return (j<7 || j%7==0) ? "#68a7ca" : "#b2d3e6";})
        .style("opacity",function(d){return (j<7 || j%7==0)? 1 : 1;})
        .on('mouseover', function(d){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          var text = d3.select(this.parentNode).select("text");
          if(indice>6 && indice%7!=0){     
            d3.select(this).transition().duration(500)
            .attr("x",1-0.1*(cwidth[indice%7]-2)).attr("y",-5).attr("width",(cwidth[indice%7]-2)*1.2).attr("height",function(d){
              return text.attr("y")==33 ? 65 : 35;
            }).style("opacity",1.0);
            text.transition().duration(500).style('font-size', '18px');
          }})
        .on('mouseout', function(d){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          var text = d3.select(this.parentNode).select("text");
          if(indice>6 && indice%7!=0){      
            d3.select(this).transition().duration(500)
            .attr("x",1).attr("y",0).attr("width",cwidth[indice%7]-2).attr("height",function(d){
              return text.attr("y")==33 ? 55 : 25;
            }).style("opacity",0.75);
            text.transition().duration(500).style('font-size', '14px');
          }})
        .on('click',function(d){if(data.indexOf(this.textContent)>6){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          var text = d3.select(this.parentNode).select("text");
          console.log(text.innerHTML,Date.now());
          dat.clicks.push([k,indice,text.innerHTML, Date.now()]);
          if(text.innerHTML == data[indice]){
            text.text(data_[indice]);
            if(text.attr("y")==33){

            }
          }
        }});
      }
    }else{
      for(j=0;j<21;j++){
        var cell = g.append("g")
          .attr("transform","translate("+cwidth.slice(0,j%7).reduce(function(a, b){return a+b;},0)+","+30*Math.floor(j/7)+")");
        var rectangle = cell.append("rect");
        var textbox = cell.append("text");
        
        textbox.attr("x",cwidth[j%7]/2)
        .attr("y",function(d){return (j>6 && j%7==0) ? 33 : 18;})
        .attr("text-anchor","middle")
        .style("font","14px sans-serif")
        .style("font-weight", function(d) { return j<7 ? "bold" : ""; })
        .text(function(d){return j==14 ? "" : data[j];})
        .on('mouseover', function(d){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          var rect = d3.select(this.parentNode).select("rect");
          if(indice>6 && indice%7!=0){     
            rect.transition().duration(500)
            .attr("x",1-0.1*(cwidth[indice%7]-2)).attr("y",-5).attr("width",(cwidth[indice%7]-2)*1.2).attr("height",35).style("opacity",1.0);
            d3.select(this).transition().duration(500).style('font-size', '18px');
          }})
        .on('mouseout', function(d){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          var rect = d3.select(this.parentNode).select("rect");
          if(indice>6 && indice%7!=0){      
            rect.transition().duration(500)
            .attr("x",1).attr("y",0).attr("width",cwidth[indice%7]-2).attr("height",25).style("opacity",0.75);
            d3.select(this).transition().duration(500).style('font-size', '14px');
          }})
        .on('click',function(d){if(data.indexOf(this.textContent)>6){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          console.log(d3.select(this)[0][0].innerHTML,Date.now());
          dat.clicks.push([k,indice,d3.select(this)[0][0].innerHTML, Date.now()]);
        }});
        
        rectangle.attr("x",1)
        .attr("y",0)
        .attr("width",cwidth[j%7]-2)
        .attr("height",function(d){if (j==14){return 0;}return j==7 ? 55 : 25;})
        .style("fill",function(d){return (j<7 || j%7==0) ? "#68a7ca" : "#b2d3e6";})
        .style("opacity",function(d){return (j<7 || j%7==0)? 1 : 1;})
        .on('mouseover', function(d){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          var text = d3.select(this.parentNode).select("text");
          if(indice>6 && indice%7!=0){     
            d3.select(this).transition().duration(500)
            .attr("x",1-0.1*(cwidth[indice%7]-2)).attr("y",-5).attr("width",(cwidth[indice%7]-2)*1.2).attr("height",35).style("opacity",1.0);
            text.transition().duration(500).style('font-size', '18px');
          }})
        .on('mouseout', function(d){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          var text = d3.select(this.parentNode).select("text");
          if(indice>6 && indice%7!=0){      
            d3.select(this).transition().duration(500)
            .attr("x",1).attr("y",0).attr("width",cwidth[indice%7]-2).attr("height",25).style("opacity",0.75);
            text.transition().duration(500).style('font-size', '14px');
          }})
        .on('click',function(d){if(data.indexOf(this.textContent)>6){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          var text = d3.select(this.parentNode).select("text");
          console.log(text.innerHTML,Date.now());
          dat.clicks.push([k,indice,text.innerHTML, Date.now()]);
        }});
    }}


    // add buttons
    var buttons = g.append("g")
    .attr("transform","translate(600,0)");
    buttons.append("rect").attr("x",0).attr("y",0).attr("width",270).attr("height",85).style("fill","#68a7ca").style("opacity",1);
    buttons.append("text").attr("x",40).attr("y",18).attr("text-anchor","middle").style("font","14px sans-serif").style("font-weight", "bold").text("Match?");
    buttons.append("text").attr("x",175).attr("y",18).attr("text-anchor","middle").style("font","14px sans-serif").style("font-weight", "bold").text("Confidence");
    //Yes
    buttons.append("svg:image").attr("xlink:href","/resources/yes.png").attr("class","yes").attr("x",10).attr("y",40).attr("width",30).attr("height",30)
      .on("mouseover",function(d){d3.select(this).transition().duration(500).attr("x",5).attr("y",35).attr("width",40).attr("height",40);})
      .on("mouseout",function(d){d3.select(this).transition().duration(500).attr("x",10).attr("y",40).attr("width",30).attr("height",30);})
      .on("click",function(d){
        buttons.select(".no").attr("opacity",0.2);
        d3.select(this).attr("opacity",1);
        console.log(k,"Yes",Date.now());
        dat.clicks.push([k,"Yes", Date.now()]);
      });
    //No
    buttons.append("svg:image").attr("xlink:href","/resources/no.png").attr("class","no").attr("x",45).attr("y",40).attr("width",30).attr("height",30)
      .on("mouseover",function(d){d3.select(this).transition().duration(500).attr("x",40).attr("y",35).attr("width",40).attr("height",40);})
      .on("mouseout",function(d){d3.select(this).transition().duration(500).attr("x",45).attr("y",40).attr("width",30).attr("height",30);})
      .on("click",function(d){
        buttons.select(".yes").attr("opacity",0.2);
        d3.select(this).attr("opacity",1);
        console.log(k,"No",Date.now());
        dat.clicks.push([k,"No", Date.now()]);
      });

    //Confidence
    buttons.append("svg:image").attr("xlink:href","/resources/small.png").attr("class","xs").attr("x",90).attr("y",40).attr("width",30).attr("height",30)
      .on("mouseover",function(d){d3.select(this).transition().duration(500).attr("x",85).attr("y",35).attr("width",40).attr("height",40);})
      .on("mouseout",function(d){d3.select(this).transition().duration(500).attr("x",90).attr("y",40).attr("width",30).attr("height",30);})
      .on("click",function(d){
        buttons.select(".s").attr("opacity",0.2);        
        buttons.select(".m").attr("opacity",0.2);
        buttons.select(".l").attr("opacity",0.2);
        buttons.select(".xl").attr("opacity",0.2);
        d3.select(this).attr("opacity",1);
        console.log(k,"XS",Date.now());
        dat.clicks.push([k,"level 1", Date.now()]);
      });
    buttons.append("svg:image").attr("xlink:href","/resources/small_medium.png").attr("class","s").attr("x",125).attr("y",40).attr("width",30).attr("height",30)
      .on("mouseover",function(d){d3.select(this).transition().duration(500).attr("x",120).attr("y",35).attr("width",40).attr("height",40);})
      .on("mouseout",function(d){d3.select(this).transition().duration(500).attr("x",125).attr("y",40).attr("width",30).attr("height",30);})
      .on("click",function(d){
        buttons.select(".xs").attr("opacity",0.2);
        buttons.select(".m").attr("opacity",0.2);
        buttons.select(".l").attr("opacity",0.2);
        buttons.select(".xl").attr("opacity",0.2);
        d3.select(this).attr("opacity",1);
        console.log(k,"S",Date.now());
        dat.clicks.push([k,"level 2", Date.now()]);
      });
    buttons.append("svg:image").attr("xlink:href","/resources/medium.png").attr("class","m").attr("x",160).attr("y",40).attr("width",30).attr("height",30)
      .on("mouseover",function(d){d3.select(this).transition().duration(500).attr("x",155).attr("y",35).attr("width",40).attr("height",40);})
      .on("mouseout",function(d){d3.select(this).transition().duration(500).attr("x",160).attr("y",40).attr("width",30).attr("height",30);})
      .on("click",function(d){
        buttons.select(".xs").attr("opacity",0.2);
        buttons.select(".s").attr("opacity",0.2);
        buttons.select(".l").attr("opacity",0.2);
        buttons.select(".xl").attr("opacity",0.2);
        d3.select(this).attr("opacity",1);
        console.log(k,"M",Date.now());
        dat.clicks.push([k,"level 3", Date.now()]);
      });
      buttons.append("svg:image").attr("xlink:href","/resources/large_medium.png").attr("class","l").attr("x",195).attr("y",40).attr("width",30).attr("height",30)
      .on("mouseover",function(d){d3.select(this).transition().duration(500).attr("x",190).attr("y",35).attr("width",40).attr("height",40);})
      .on("mouseout",function(d){d3.select(this).transition().duration(500).attr("x",195).attr("y",40).attr("width",30).attr("height",30);})
      .on("click",function(d){
        buttons.select(".xs").attr("opacity",0.2);
        buttons.select(".s").attr("opacity",0.2);
        buttons.select(".m").attr("opacity",0.2);
        buttons.select(".xl").attr("opacity",0.2);
        d3.select(this).attr("opacity",1);
        console.log(k,"L",Date.now());
        dat.clicks.push([k,"level 4", Date.now()]);
      });
      buttons.append("svg:image").attr("xlink:href","/resources/large.png").attr("class","xl").attr("x",230).attr("y",40).attr("width",30).attr("height",30)
      .on("mouseover",function(d){d3.select(this).transition().duration(500).attr("x",225).attr("y",35).attr("width",40).attr("height",40);})
      .on("mouseout",function(d){d3.select(this).transition().duration(500).attr("x",230).attr("y",40).attr("width",30).attr("height",30);})
      .on("click",function(d){
        buttons.select(".xs").attr("opacity",0.2);
        buttons.select(".s").attr("opacity",0.2);
        buttons.select(".m").attr("opacity",0.2);
        buttons.select(".l").attr("opacity",0.2);
        d3.select(this).attr("opacity",1);
        console.log(k,"XL",Date.now());
        dat.clicks.push([k,"level 5", Date.now()]);
      });
  }




  function showNext(label){
    d3.text("data_alt.csv", function(csvdata) {
      var parsedCSV = d3.csv.parseRows(csvdata);
      var title = parsedCSV[0];
      for (i=0;i<group[label].length;i++){
        if(experimentr.data()["mode"]=="Partial"){
            block(i,(title.slice(0,7)
              .concat([group[label][i][0][0]])
              .concat(group[label][i][0].slice(8,14))
              .concat([group[label][i][1][0]])
              .concat(group[label][i][1].slice(8,14))),
            title.slice(0,7).concat(group[label][i][0].slice(0,7)).concat(group[label][i][1].slice(0,7))
            );
        }else{
            block(i,title.slice(0,7).concat(group[label][i][0].slice(0,7)).concat(group[label][i][1].slice(0,7)),[]);
        }
      }});
  }
  
  function goToNext() {
    experimentr.endTimer('instructions');
    experimentr.addData(dat);
    experimentr.next();
  }
  d3.select('#ready_button')
    .on('click', function () {
      d3.select("svg").selectAll("g").remove();
      if (label<group.length){
        showNext(label);
        label = label+1;
      }else{
        goToNext();
      }
    });
}());
</script>