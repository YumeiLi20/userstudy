<div id="instruction">
<h1>Instructions</h1>

<p style="font-weight:bold">[Warning: do not refresh your web browser before the end of the user study. ]</p>

<p>Thank you for participating in our user study, and for the next while you will be completing some trials.<br> <br>

In this study, you are going to give answers to 30 questions. For each question, you need to decide the likelihood between a pair of records based on the information provided.<br><br>
</p></div>
<div id="title1" style="display:none"><h1>Full Disclosure</h1></div>
<div id="mode1" style="display:none">In the [Full Disclosure] mode, all the cells are visible.</div>
<div id="title2" style="display:none"><h1>Full Disclosure For Different Cells</h1></div>

<div id="mode2" style="display:none">In the [Full Disclosure For Different Cells] mode, only different cells in a pair are visible. Dashed lines represent the identical text in a pair.</div>
<div id="title3" style="display:none"><h1>Partial Disclosure Reveal Cell On Click</h1></div>

<div id="mode3" style="display:none">In the [Paritial Disclosure Reveal Cell On Click] mode, only the minimum differences are visible at start. However, you can click the cells which are partial visible, then the cells pair will be shown.Dashed lines represent the identical text in a pair.</div>
<div id="title4" style="display:none"><h1>Partial Disclosure Reveal Row On Click</h1></div>

<div id="mode4" style="display:none">In the [Paritial Disclosure Reveal Row On Click] mode, only the minimum differences are visible at start. However, you can click the cells which are partial visible, then all the cells with differences in the pait will be shown.Dashed lines represent the identical text in a pair.</div>
<div id="title5" style="display:none"><h1>Minimum Disclosure Non-clickable</h1></div>

<div id="mode5" style="display:none">In the [Minimum Disclosure Non-clickable] mode, only the minimum differences are shown. Dashed lines represent the identical text in a pair.</div>
<div id="example">
Here are some sample questions:<br>

<div id="binary_div">A pair example:</div>

<div id="other_div">Multiple pairs example:</div>

The likelihood is scaled into 6 levels: <br>
1. Highly likely same<br>
2. Moderately likely same<br>
3. Slightly likely same<br>
4. Highly likely different<br>
5. Moderately likely different<br>
6. Slightly likely different<br><br>

You need to choose one and only one answer for each pair and you are free to change your answers before clicking “Next” button.<br></p>
</div>



<body>
<button id="ready_button" class="next-button" type="button">Next</button>
</body>



<script>
(function() {
  experimentr.hideNext();

  experimentr.startTimer('instructions');
  var dat = {};
  dat.clicks = [];
  var label = 0;
  
  var group = [];
  var svg = d3.select("body").append("svg").attr("class","blocks")
            .attr("width", 1200)
            .attr("height", 600);
  var binary_svg = d3.select("#binary_div").append("svg").attr("width",1200).attr("height",100)
  var other_svg = d3.select("#other_div").append("svg").attr("width",1200).attr("height",200)

  var cwidth = [60,120,140,50,60,90,90]; //610

  d3.select("#mode1").style("display",function(d){return experimentr.data()["mode"]=="Full" ? "block":"none";});
  d3.select("#mode2").style("display",function(d){return experimentr.data()["mode"]=="Full_Partial" ? "block":"none";});
  d3.select("#mode3").style("display",function(d){return experimentr.data()["mode"]=="Partial_Cell" ? "block":"none";});
  d3.select("#mode4").style("display",function(d){return experimentr.data()["mode"]=="Partial_Row" ? "block":"none";});
  d3.select("#mode5").style("display",function(d){return experimentr.data()["mode"]=="Partial" ? "block":"none";});
  
  parsing("data_.csv");
  introduce();
  console.log(experimentr.data()["mode"]);
  
  function parsing(route){
    d3.text(route,function(csvdata){
      var groups = {};
        var parsedCSV = d3.csv.parseRows(csvdata);
        for(i=1;i<parsedCSV.length;i++){
          if (!(parsedCSV[i][0] in groups)){
            groups[parsedCSV[i][0]] = [parsedCSV[i]];
          }else{
            groups[parsedCSV[i][0]] = groups[parsedCSV[i][0]].concat([parsedCSV[i]]);
          }
        }
        var values = Object.keys(groups).map(function(key){return groups[key];}); 
        var raw_binary = values.filter(function(d){return d.length==2;});
        var binary = [];
        var other = [];
        var tmp = [];
        for(i=0;i<raw_binary.length;i++){
          if(tmp.length===5 || i===raw_binary.length-1){
            binary.push(tmp);
            tmp = [];
          }else{
            tmp.push(raw_binary[i]);
          }
        }
        var tmp = values.filter(function(d){return d.length==4;});
        for(i=0;i<tmp.length;i++){
          var t = [];
          for(j=0;j<tmp[i].length/2;j++){
            t.push([tmp[i][2*j],tmp[i][2*j+1]]);
          }
          other.push(t);
        }
        tmp = values.filter(function(d){return d.length==6;});
        for(i=0;i<tmp.length;i++){
          var t = [];
          for(j=0;j<tmp[i].length/2;j++){
            t.push([tmp[i][2*j],tmp[i][2*j+1]]);
          }
          other.push(t);
        }
        group = binary.concat(other);
        //console.log(group);
        if(route=="data_.csv"){introduce();}
      });
  }

  function introduce(){
    showNext(0,binary_svg);
    showNext(0,other_svg);
  }

  function block(svg,k,data,data_,mode){
    var g = svg.append("g").attr("class","block")
      .attr("transform","translate(0,"+100*k+")");
    if(mode=="Partial_Cell"|| mode=="Partial_Row"|| mode=="Partial" || mode=="Full_Partial"){
      for(j=0;j<21;j++){
        var cell = g.append("g")
          .attr("transform","translate("+cwidth.slice(0,j%7).reduce(function(a, b){return a+b;},0)+","+30*Math.floor(j/7)+")");
        var rectangle = cell.append("rect");
        var textbox = cell.append("text");
        textbox.attr("x",cwidth[j%7]/2)
        .attr("y",function(d){return (j<14 && data[j]==data[j+7])||(j>6 && j%7==0)||(j>14 && data[j]==data[j-7]) ? 33 : 18;})
        .attr("text-anchor","middle")
        .style("font","14px sans-serif")
        .style("font-weight", function(d) { return j<7 ? "bold" : ""; })
        .text(function(d){
          if(mode=="Full_Partial"){
            if(j>=14 && data[j]==data[j-7]){return ""}else{
                return j>6 && j%7!=0 && d3.select(this).attr("y")==18 ? data_[j] : data[j];
            }
          }else{
            return (j>14 && data[j]==data[j-7])||j==14 ? "" : data[j];}});

        rectangle.attr("x",1)
        .attr("y",0)
        .attr("width",cwidth[j%7]-2)
        .attr("height",function(d){if ((j>14 && data[j]==data[j-7])||j==14){return 0;}return (j<14 && data[j]==data[j+7])||j==7 ? 55 : 25;})
        .style("fill",function(d){return (j<7 || j%7==0) ? "#68a7ca" : "#b2d3e6";})
        .style("opacity",1);

        //Actions only for clickable modes
        if(mode=="Partial_Row"||mode=="Partial_Cell"){
          textbox.on('mouseover', function(d){
          var indice = $(this.parentNode).parent().children().index(this.parentNode);
          var rect = d3.select(this.parentNode).select("rect");

          if(indice>13 && indice%7!=0 && d3.select(this).attr("y")==18 && data[indice]!="" && data[indice]!="Miss" && data[indice]!=data_[indice]) {     
            rect.transition().duration(500)
            .style("fill","#379037");
            d3.select(this).transition().duration(500).style('font-weight', 'bold');
            d3.select($(this.parentNode.parentNode).children()[indice-7]).select("text").transition().duration(500).style('font-weight', 'bold');
            d3.select($(this.parentNode.parentNode).children()[indice-7]).select("rect").transition().duration(500).style("fill","#379037");
          }
          if(indice>6 && indice<14 && d3.select(this).attr("y")==18 && data[indice]!="" && data[indice]!="Miss" && data[indice]!=data_[indice]){
            rect.transition().duration(500)
            .style("fill","#379037");
            d3.select(this).transition().duration(500).style('font-weight', 'bold');
            d3.select($(this.parentNode.parentNode).children()[indice+7]).select("text").transition().duration(500).style('font-weight', 'bold');
            d3.select($(this.parentNode.parentNode).children()[indice+7]).select("rect").transition().duration(500).style("fill","#379037");
          }

        })
          .on('mouseout', function(d){
            var indice = $(this.parentNode).parent().children().index(this.parentNode);
            var rect = d3.select(this.parentNode).select("rect");
            if(indice>13 && indice%7!=0 && d3.select(this).attr("y")==18 && data[indice]!="" && data[indice]!="Miss" && data[indice]!=data_[indice]){      
              rect.transition()//.duration(500)
              .style("fill","#b2d3e6");
              d3.select(this).transition().duration(500).style('font-weight', 'normal');
              d3.select($(this.parentNode.parentNode).children()[indice-7]).select("text").transition().duration(500).style('font-weight', 'normal');
              d3.select($(this.parentNode.parentNode).children()[indice-7]).select("rect").transition().duration(500).style("fill","#b2d3e6");
            }
            if(indice>6 && indice<14 && indice%7!=0 && d3.select(this).attr("y")==18 && data[indice]!="" && data[indice]!="Miss" && data[indice]!=data_[indice]){
              rect.transition()//.duration(500)
              .style("fill","#b2d3e6");
              d3.select(this).transition().duration(500).style('font-weight', 'normal');
              d3.select($(this.parentNode.parentNode).children()[indice+7]).select("text").transition().duration(500).style('font-weight', 'normal');
              d3.select($(this.parentNode.parentNode).children()[indice+7]).select("rect").transition().duration(500).style("fill","#b2d3e6");
            }
          })
          .on('click',function(d){if(data.indexOf(this.textContent)>6){
            var indice = $(this.parentNode).parent().children().index(this.parentNode);
            console.log(d3.select(this)[0][0].innerHTML,Date.now());
            dat.clicks.push([k,indice,d3.select(this)[0][0].innerHTML, Date.now()]);
            var siblings = d3.select(".blocks").selectAll(".block")[0].length;
            //console.log(d3.select(".blocks").selectAll(".block"));
            if(siblings<5){
              d3.text("data_alt.csv", function(csvdata) {
                var parsedCSV = d3.csv.parseRows(csvdata);
                var title = parsedCSV[0];
                console.log(group);
                if(label>0){
                  label=label-1;
                }
                d3.select(".blocks").selectAll(".block").remove();
                for (i=0;i<group[label].length;i++){
                    var raw_string = title.slice(0,7)
                        .concat([group[label][i][0][0]])
                        .concat(group[label][i][0].slice(8,14))
                        .concat([group[label][i][1][0]])
                        .concat(group[label][i][1].slice(8,14));
                    var alt_string = title.slice(0,7).concat(group[label][i][0].slice(0,7)).concat(group[label][i][1].slice(0,7));
                    console.log(raw_string,alt_string);
                    if(mode=="Partial_Row"){block(svg,i,raw_string,alt_string,"Full_Partial");}
                    else{
                      raw_string[indice]=alt_string[indice];
                      if(indice>13){
                        raw_string[indice-7]=alt_string[indice-7];
                        group[label][i][1][indice-7]=raw_string[indice];
                        group[label][i][0][indice-7]=raw_string[indice-7];
                      }else{
                        raw_string[indice+7]=alt_string[indice+7];
                        group[label][i][0][indice-7]=raw_string[indice];
                        group[label][i][1][indice-7]=raw_string[indice+7];
                      }
                      block(svg,i,raw_string,alt_string,"Partial_Cell")
                    }
                  }
                  label+=1;
              });
            }else{
              if(d3.select(this)[0][0].innerHTML == data[indice] && data[indice]!="" && data[indice]!="Miss" && data[indice]!=data_[indice]){
                d3.select(this).text(data_[indice]);
                if(mode=="Partial_Cell"){
                  if(indice>13){
                    d3.select($(this.parentNode.parentNode).children()[indice-7]).select("text").text(data_[indice-7]);
                  }else{
                    d3.select($(this.parentNode.parentNode).children()[indice+7]).select("text").text(data_[indice+7]);
                  }  
                }else{
                  for(i=7;i<21;i++){
                    if(i%7!=0 && d3.select($(this.parentNode.parentNode).children()[i]).select("text").attr("y")==18 && d3.select($(this.parentNode.parentNode).children()[i]).select("text").innerHTML!=""){
                      d3.select($(this.parentNode.parentNode).children()[i]).select("text").text(data_[i]);
                    }
                  }
                }
              }
          }}});
        
          rectangle.on('mouseover', function(d){
            var indice = $(this.parentNode).parent().children().index(this.parentNode);
            var text = d3.select(this.parentNode).select("text");
            if(indice>13 && indice%7!=0 && text.attr("y")==18 && data[indice]!="" && data[indice]!="Miss" && data[indice]!=data_[indice]){     
              d3.select(this).transition().duration(500)
              .style("fill","#379037");
              text.transition().duration(500).style('font-weight', 'bold');
              d3.select($(this.parentNode.parentNode).children()[indice-7]).select("text").transition().duration(500).style('font-weight', 'bold');
              d3.select($(this.parentNode.parentNode).children()[indice-7]).select("rect").transition().duration(500).style("fill","#379037");
            }
            if(indice>6 && indice<14 && indice%7!=0 && text.attr("y")==18 && data[indice]!="" && data[indice]!="Miss" && data[indice]!=data_[indice]){     
              d3.select(this).transition().duration(500)
              .style("fill","#379037");
              text.transition().duration(500).style('font-weight', 'bold');
              d3.select($(this.parentNode.parentNode).children()[indice+7]).select("text").transition().duration(500).style('font-weight', 'bold');
              d3.select($(this.parentNode.parentNode).children()[indice+7]).select("rect").transition().duration(500).style("fill","#379037");
            }
          })
          .on('mouseout', function(d){
            var indice = $(this.parentNode).parent().children().index(this.parentNode);
            var text = d3.select(this.parentNode).select("text");
            if(indice>13 && indice%7!=0 && text.attr("y") && data[indice]!="" && data[indice]!="Miss" && data[indice]!=data_[indice]){      
              d3.select(this).transition()//.duration(500)
              .style("fill","#b2d3e6");
              text.transition().duration(500).style('font-weight', 'normal');
              d3.select($(this.parentNode.parentNode).children()[indice-7]).select("text").transition().duration(500).style('font-weight', 'normal');
              d3.select($(this.parentNode.parentNode).children()[indice-7]).select("rect").transition().duration(500).style("fill","#b2d3e6");
            }
            if(indice>6 && indice<14 && indice%7!=0 && text.attr("y")==18 && data[indice]!="" && data[indice]!="Miss" && data[indice]!=data_[indice]){     
              d3.select(this).transition().duration(500)
              .style("fill","#b2d3e6");
              text.transition().duration(500).style('font-weight', 'normal');
              d3.select($(this.parentNode.parentNode).children()[indice+7]).select("text").transition().duration(500).style('font-weight', 'normal');
              d3.select($(this.parentNode.parentNode).children()[indice+7]).select("rect").transition().duration(500).style("fill","#b2d3e6");

            }})
          .on('click',function(d){
            var indice = $(this.parentNode).parent().children().index(this.parentNode);
            var text = d3.select(this.parentNode).select("text");
            console.log(data[indice],Date.now());
            var siblings = d3.select(".blocks").selectAll(".block")[0].length;
            if(siblings<5){
              d3.text("data_alt.csv", function(csvdata) {
                var parsedCSV = d3.csv.parseRows(csvdata);
                var title = parsedCSV[0];
                d3.select(".blocks").selectAll(".block").remove();
                if(label>0){
                  label=label-1;
                }
                for (i=0;i<group[label].length;i++){
                    var raw_string = title.slice(0,7)
                        .concat([group[label][i][0][0]])
                        .concat(group[label][i][0].slice(8,14))
                        .concat([group[label][i][1][0]])
                        .concat(group[label][i][1].slice(8,14));
                    var alt_string = title.slice(0,7).concat(group[label][i][0].slice(0,7)).concat(group[label][i][1].slice(0,7));
                    if(mode=="Partial_Row"){block(svg,i,raw_string,alt_string,"Full_Partial");}
                    else{
                      raw_string[indice]=alt_string[indice];
                      if(indice>13){
                        raw_string[indice-7]=alt_string[indice-7];
                        group[label][i][1][indice-7]=raw_string[indice];
                        group[label][i][0][indice-7]=raw_string[indice-7];
                      }else{
                        raw_string[indice+7]=alt_string[indice+7];
                        group[label][i][0][indice-7]=raw_string[indice];
                        group[label][i][1][indice-7]=raw_string[indice+7];
                      }
                      block(svg,i,raw_string,alt_string,"Partial_Cell")
                    }
                  }
                  label+=1;
              });
            }else{
            if(data.indexOf(text[0][0].innerHTML)>6 && text.attr("y")==18 && data[indice]!="" && data[indice]!="Miss" && data[indice]!=data_[indice]){
              console.log(text[0][0].innerHTML,Date.now());
              dat.clicks.push([k,indice,text[0][0].innerHTML, Date.now()]);
              if(text[0][0].innerHTML == data[indice]){
                text.text(data_[indice]);
                if(mode=="Partial_Cell"){
                  if(indice>13){
                    d3.select($(this.parentNode.parentNode).children()[indice-7]).select("text").text(data_[indice-7]);
                  }else{
                    d3.select($(this.parentNode.parentNode).children()[indice+7]).select("text").text(data_[indice+7]);
                  }  
                }else{
                  for(i=7;i<21;i++){
                    if(i%7!=0 && d3.select($(this.parentNode.parentNode).children()[i]).select("text").textContent!="" && d3.select($(this.parentNode.parentNode).children()[i]).select("text").attr("y")==18){
                      d3.select($(this.parentNode.parentNode).children()[i]).select("text").text(data_[i]);
                    }
                  }
                }            
            }
          }}});
        }
        
      }
    }
    if(experimentr.data()["mode"]=="Full"){
      for(j=0;j<21;j++){
        var cell = g.append("g")
          .attr("transform","translate("+cwidth.slice(0,j%7).reduce(function(a, b){return a+b;},0)+","+30*Math.floor(j/7)+")");
        var rectangle = cell.append("rect");
        var textbox = cell.append("text");
        
        textbox.attr("x",cwidth[j%7]/2)
        .attr("y",function(d){return (j>6 && j%7==0) ? 33 : 18;})
        .attr("text-anchor","middle")
        .style("font","14px sans-serif")
        .style("font-weight", function(d) { return j<7 ? "bold" : ""; })
        .text(function(d){return j==14 ? "" : data[j];});
        
        rectangle.attr("x",1)
        .attr("y",0)
        .attr("width",cwidth[j%7]-2)
        .attr("height",function(d){if (j==14){return 0;}return j==7 ? 55 : 25;})
        .style("fill",function(d){return (j<7 || j%7==0) ? "#68a7ca" : "#b2d3e6";})
        .style("opacity",1);
    }}

    var options = ["Highly Likely Same",
                   "Highly Likely Different",
                   "Moderately Likely Same",
                   "Moderately Likely Different",
                   "Slightly Likely Same",
                   "Slightly Likely Different"];
    var x = [10,200,10,200,10,200];
    var y = [10,10,40,40,70,70];
    // add buttons
    var buttons = g.append("g").attr("transform","translate(620,0)");
    buttons.append("rect").attr("x",0).attr("y",0).attr("width",400).attr("height",85).style("fill","#68a7ca").style("opacity",1);
    for(m=0;m<6;m++){
      var radioButton = buttons.append("g").attr("transform","translate("+x[m]+","+y[m]+")");
      radioButton.append("text").attr("x",25).attr("y",10).attr("text-anchor","left").style("font","14px sans-serif").text(options[m]);
      radioButton.append("svg:image").attr("xlink:href","/resources/0.png").attr("class","choice").attr("x",0).attr("y",-5).attr("width",18).attr("height",18);
      radioButton.on({"mouseover": function(d) {d3.select(this).style("cursor", "pointer")},
             "mouseout": function(d) {d3.select(this).style("cursor", "default")}})
        .on("click",function(d){
          buttons.select(".no").attr("opacity",0.2);
          buttons.selectAll("image").attr("xlink:href","/resources/0.png");
          d3.select(this).select("image").attr("xlink:href","/resources/1.png");
          console.log(k,d3.select(this).select("text").text(),Date.now());
          dat.clicks.push([k, Date.now()]);
        });
    }
  }


  function showNext(label,svg){
    d3.text("data_.csv", function(csvdata) {
      var parsedCSV = d3.csv.parseRows(csvdata);
      var title = parsedCSV[0];
      for (i=0;i<group[label].length;i++){
        if(experimentr.data()["mode"]!="Full"){
            block(svg,i,(title.slice(0,7)
              .concat([group[label][i][0][0]])
              .concat(group[label][i][0].slice(8,14))
              .concat([group[label][i][1][0]])
              .concat(group[label][i][1].slice(8,14))),
            title.slice(0,7).concat(group[label][i][0].slice(0,7)).concat(group[label][i][1].slice(0,7)),
            experimentr.data()["mode"]);
        }else{
            block(svg,i,title.slice(0,7).concat(group[label][i][0].slice(0,7)).concat(group[label][i][1].slice(0,7)),[],experimentr.data()["mode"]);
        }
      }});
  }
  
  function goToNext() {
    experimentr.endTimer('instructions');
    experimentr.addData(dat);
    experimentr.next();
  }
  d3.select('#ready_button')
    .on('click', function () {
      if(d3.select("#instruction").style("display")=="block"){
        d3.select("#instruction").style("display","none");
        d3.select("#example").style("display","none");
        label=0;
        parsing("data_alt.csv");
        d3.select("#title1").style("display",function(d){return experimentr.data()["mode"]=="Full" ? "block":"none";})
        d3.select("#title2").style("display",function(d){return experimentr.data()["mode"]=="Full_Partial" ? "block":"none";})
        d3.select("#title3").style("display",function(d){return experimentr.data()["mode"]=="Partial_Cell" ? "block":"none";})
        d3.select("#title4").style("display",function(d){return experimentr.data()["mode"]=="Partial_Row" ? "block":"none";})
        d3.select("#title5").style("display",function(d){return experimentr.data()["mode"]=="Partial" ? "block":"none";})
      }
      else{
        if (label<group.length){
          showNext(label,svg);
          d3.select(".blocks").selectAll("g").remove();
          label = label+1;
        }else{
          goToNext();
        }
      }
    });
}());
</script>
